
   WITH base AS (  
    SELECT
        *,
        LAG(CLOSE, 1, 0) over (PARTITION BY TICKER ORDER BY DATETIME) AS PREV_PRICE,
        AVG(CLOSE) OVER (PARTITION BY TICKER ORDER BY DATETIME ROWS BETWEEN 4 PRECEDING AND CURRENT ROW) AS SMA_5,
        AVG(CLOSE) OVER (PARTITION BY TICKER ORDER BY DATETIME ROWS BETWEEN 20 PRECEDING AND CURRENT ROW) AS SMA_20,
        AVG(VOLUME) OVER (PARTITION BY TICKER ORDER BY DATETIME ROWS BETWEEN 20 PRECEDING AND CURRENT ROW) AS VOL_20,
        (HIGH - LOW) / NULLIF(CLOSE, 0) AS VOLATILITY
    FROM {{ ref('stg_price') }}
   )

SELECT
    *,
    (CLOSE - PREV_PRICE) / NULLIF(PREV_PRICE, 0) AS PERC_CHANGE,
FROM base